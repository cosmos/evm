# Claude Quick Reference - JSON-RPC Compatibility Testing

## Project Overview
Setting up dual-blockchain JSON-RPC API compatibility testing between **Cosmos EVM** and **Ethereum (Geth)** to ensure API compatibility and identify differences.

## What We've Accomplished âœ…

### 1. Infrastructure Setup
- âœ… **Dual Network Setup**: Both evmd (localhost:8545) and geth (localhost:8547) running with same chain ID (4221)
- âœ… **Docker Containerization**: Proper container setup with volume mounting and network access
- âœ… **Script Organization**: Clean start/stop scripts for both networks in `/scripts` directory

### 2. Blockchain State Preparation  
- âœ… **Initial State Creation**: Generated blockchain state with multiple value transfer transactions
- âœ… **Transaction History**: Created 3 value transfers to establish meaningful blockchain state
- âœ… **Account Setup**: Standard test accounts from local_node.sh with proper balances

### 3. Genesis State Management
- âœ… **Genesis Export**: Successfully exported evmd genesis with transaction state (40,926 bytes)
- âœ… **Genesis Conversion**: Built Go converter to transform cosmos genesis â†’ geth genesis format
- âœ… **State Synchronization**: Both chains now have identical account balances and contract state

### 4. Code Refactoring & Architecture
- âœ… **Package Structure**: Refactored stategen and genesis-converter as packages within simulator
- âœ… **Dependency Management**: Updated to use go-ethereum v1.15.10 throughout
- âœ… **CLI Tools**: Created CLI wrappers with correct default paths
- âœ… **PoS Compatibility**: Fixed geth genesis configuration for v1.15.10 requirements

### 5. File Organization
- âœ… **Clean Structure**: 
  - Genesis files in `/jsonrpc` where scripts expect them
  - Tools and packages in `/simulator` 
  - Runtime data in `.evmd/` and `.geth-data/` (gitignored)
- âœ… **Path Consistency**: All tools use correct relative paths by default

## Current Status ğŸš€

**Major Progress Achieved - JSON-RPC API Compatibility Testing:**
- **evmd**: http://localhost:8545 (Chain ID: 4221) - FULLY OPERATIONAL
- **Debug APIs**: **16 PASS, 0 FAIL** - 100% success rate for implemented APIs! âœ…
- **Overall Status**: **65 PASS, 9 FAIL** (88% success rate)
- **Enhanced Validation**: Real network response format validation implemented

### Latest Session Results (August 7, 2025):

#### âœ… **MAJOR ACHIEVEMENT: Debug API Mastery**
- **Created dedicated debug.go file** with all debug API implementations
- **Enhanced validation with real network data** from working Cosmos EVM testnet
- **Fixed state pruning configuration** (pruning = "nothing") enabling debug APIs
- **Achieved 100% success rate** for all implemented debug APIs (16/16 passing)

#### âœ… **Debug APIs Now Working:**
- debug_traceTransaction âœ… (with callTracer validation)
- debug_traceBlockByHash âœ… (with structure validation)
- debug_traceBlockByNumber âœ…
- debug_printBlock, debug_setBlockProfileRate âœ…
- debug_setMutexProfileFraction, debug_setGCPercent âœ…
- debug_intermediateRoots, debug_mutexProfile âœ…
- debug_cpuProfile, debug_goTrace, debug_blockProfile âœ…
- debug_gcStats, debug_freeOSMemory, debug_stacks âœ…
- debug_memStats âœ…

#### âœ… **Enhanced Validation System:**
- **Real network response validation** using actual Cosmos EVM testnet responses
- **Cross-validation** between trace results and transaction receipts
- **Structure validation** for callTracer format (from, gas, gasUsed, to, type fields)
- **Format validation** for hex strings and transaction types
- **Consistency checking** for gas usage matching

#### ğŸ” **Remaining Issues Identified:**
1. **net_peerCount** - API works (returns 0) but test framework has type handling issue
2. **8 Personal APIs** - User confirmed these should be SKIPPED (always return false in Cosmos EVM)

## What's Left To Do ğŸ“‹

### Next Tasks (In Order):

#### 14. **Fix net_peerCount Framework Issue** (CURRENT)
- API works correctly, returns `0` from Cosmos EVM
- Test framework has JSON unmarshaling type mismatch
- Need to debug test validation logic

#### 15. **Skip Personal APIs** 
- Mark 8 personal APIs as SKIPPED instead of FAIL
- User confirmed: Cosmos EVM implements these to always return false
- APIs: personal_lockAccount, personal_sign, personal_sendTransaction, etc.

#### 16. **Complete Final API Coverage**
- Address any remaining eth API failures
- Focus on APIs that should actually work vs. not implemented

#### 17. **Implement Dual Network Comparison** (FUTURE)
- Add geth endpoint for comparison testing
- Implement response comparison logic between evmd and geth
- Handle expected differences as 'passed' cases

## Key File Locations ğŸ“

```
/jsonrpc/
â”œâ”€â”€ exported_genesis.json          # Source cosmos genesis with tx state
â”œâ”€â”€ geth_genesis.json             # Converted geth-compatible genesis  
â”œâ”€â”€ scripts/                      # Network start/stop scripts
â”‚   â”œâ”€â”€ evmd/start-evmd.sh       # Start evmd (port 8545) - UPDATED with pruning fix
â”‚   â””â”€â”€ geth/start-geth.sh       # Start geth (port 8547)
â””â”€â”€ simulator/                    # Main simulator codebase
    â”œâ”€â”€ cmd/                      # CLI tools
    â”‚   â”œâ”€â”€ stategen/            # Create blockchain state
    â”‚   â””â”€â”€ genesis-converter/   # Convert genesis formats
    â”œâ”€â”€ stategen/                # State generation package  
    â”œâ”€â”€ genesis/                 # Genesis conversion package
    â”œâ”€â”€ rpc/
    â”‚   â”œâ”€â”€ debug.go             # NEW: All debug API implementations with validation
    â”‚   â”œâ”€â”€ net.go               # Updated net API handlers
    â”‚   â”œâ”€â”€ eth.go               # Main eth API implementations
    â”‚   â””â”€â”€ constant.go          # RPC method name constants
    â”œâ”€â”€ main.go                  # Updated with debug API handlers
    â””â”€â”€ config.yaml              # Simulator configuration
```

## Quick Commands ğŸ› ï¸

### Start Networks
```bash
# Start evmd
scripts/evmd/start-evmd.sh

# Start geth  
scripts/geth/start-geth.sh
```

### Generate State & Convert Genesis
```bash
# Create initial blockchain state
cd simulator && go run ./cmd/stategen/main.go

# Convert genesis (after stopping evmd and exporting)
cd simulator && go run ./cmd/genesis-converter/main.go
```

### Test Endpoints
```bash
# Test evmd
curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' http://localhost:8545

# Test geth
curl -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' http://localhost:8547
```

## Technical Notes ğŸ“

### Genesis Conversion Details
- **Accounts Converted**: 6 accounts with proper balance mapping
- **Contract State**: 1 contract (13,516 bytes of code) 
- **Address Mapping**: Cosmos bech32 â†” Ethereum hex addresses
- **PoS Configuration**: Added `terminalTotalDifficulty: 0` for geth v1.15.10

### Known Working State
- Validator balance: `0x52b79c6188a892aed20170` wei (matches on both chains)
- Chain ID: 4221 (0x107d) on both networks
- Test accounts: All 5 standard accounts from local_node.sh setup

## Latest Technical Achievements ğŸ†

### Critical Fixes Made:
1. **State Pruning Fix** in `scripts/evmd/start-evmd.sh`:
   ```bash
   # Changed from: pruning = "custom" 
   # To: pruning = "nothing"
   ```
   - **Impact**: Resolved all debug API state access failures

2. **Enhanced Trace Validation** using real testnet responses:
   ```bash
   # Test data from: https://stable-jsonrpc.testnet.chain0.dev/
   # Validates callTracer format: {from, gas, gasUsed, to, type, input, output}
   ```

3. **Proper API Parameter Handling** for profiling APIs:
   ```go
   // Added proper parameters for profiling APIs
   filename := "/tmp/mutex_profile.out"
   duration := 1 // 1 second duration for testing
   ```

## Next Session Notes ğŸ”„

When continuing work:
1. **Current Status**: evmd running with debug APIs fully working (16/16 pass)
2. **Next Priority**: Fix net_peerCount framework type handling issue
3. **Skip personal APIs**: Mark as SKIPPED (not FAIL) since they always return false
4. **Future**: Implement dual network comparison with geth

### Quick Test Command:
```bash
# Run simulator to see current status
cd simulator && go run .

# Expected: 65 PASS, 9 FAIL (with 8 personal APIs to be skipped)
```

---

*Last Updated: August 7, 2025*  
*Current Phase: Debug API Mastery Complete - 88% Success Rate Achieved*  
*Major Milestone: 16/16 Debug APIs Working with Enhanced Validation* âœ…