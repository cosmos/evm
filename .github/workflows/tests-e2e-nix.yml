name: E2E Nix Tests
on:
  push:
    branches: [ main, release/** ]
  pull_request:
    branches: [ main, release/** ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-env:
    runs-on: ubuntu-latest
    outputs:
      run_tests: ${{ steps.set-run-tests.outputs.run_tests }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
      - name: Skip marker (commit message)
        run: |
          msg="$(git log -1 --pretty=%B)"
          if echo "$msg" | grep -qi '\[skip e2e\]'; then
            echo "Skipping E2E by marker."
            echo "run_tests=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
      - id: changed-files
        uses: tj-actions/changed-files@ed68ef82c095e0d48ec87eccea555d944a631a4c
        with:
          files: |
            docs/**
            **/*.md
      - id: set-run-tests
        run: |
          if [ "${{ steps.changed-files.outputs.only_changed }}" = "true" ]; then
            echo "Docs-only change detected. Skipping tests."
            echo "run_tests=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "run_tests=true" >> "$GITHUB_OUTPUT"
      - name: Free disk space
        if: steps.set-run-tests.outputs.run_tests == 'true'
        run: sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY" || true
      - name: Install Nix
        if: steps.set-run-tests.outputs.run_tests == 'true'
        uses: cachix/install-nix-action@ba0dd844c9180cbf77aa72a116d6fbc515d0e87b
        with:
          nix_path: nixpkgs=channel:nixos-25.05
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            sandbox = false
      - name: Enable Magic Nix Cache
        if: steps.set-run-tests.outputs.run_tests == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Pre-build dependencies (warm cache)
        if: steps.set-run-tests.outputs.run_tests == 'true'
        run: |
          nix build .#evmd .#hermes || true
  integration_tests:
    needs: build-env
    if: needs.build-env.outputs.run_tests == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      fail-fast: true
      matrix:
        group: [all]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
      - name: Install Nix
        uses: cachix/install-nix-action@ba0dd844c9180cbf77aa72a116d6fbc515d0e87b
        with:
          nix_path: nixpkgs=channel:nixos-25.05
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            sandbox = false
      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Run test group via Makefile
        env:
          TESTS_TO_RUN: ${{ matrix.group }}
        run: make test-e2e-nix TESTS_TO_RUN="${TESTS_TO_RUN}"
      - name: Collect debug artifacts
        if: failure()
        run: tar cfz debug_${{ matrix.group }}.tar.gz -C "${TMPDIR-/tmp}/pytest-of-runner" . || true
      - name: Upload debug artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-${{ matrix.group }}
          path: debug_${{ matrix.group }}.tar.gz
          if-no-files-found: ignore
